<!DOCTYPE html>
<html lang="en" style="min-height: 100%">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <meta content="" name="description">
  <meta content="" name="author">
  <title>Plex Movie Downloader - Movies</title><!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.css" rel="stylesheet"><!-- Custom styles for this template -->
  <link href="css/4-col-portfolio.css" rel="stylesheet">
  <script src='/socket.io/socket.io.js'>
  </script>
  <script>
       var socket = io('http://localhost:8080');
       
       socket.on('connect',function(){
         load_data();
       });
     

       var offset = 0;
       var size = 20;

       function download_movie(uid){
         socket.emit('download_req',{type:"movies",uid:uid,offset: offset,size: size});
         load_data();
       }

       function next_page(click){
         offset+=size;
         load_data();      
       }
       function previous_page(click){
         if(offset-size>=0){
           offset-=size;
           load_data();        
         }
       }

       function load_data(){
         socket.emit('media_req',{type: "movies",offset: offset,size: size});      
       }

       function build_data(data){
         var container = document.getElementsByClassName("container")[1];

         var old_row = document.getElementsByClassName("row");
         if(old_row.length){
           container.removeChild(old_row[0]);
         }

         var row = document.createElement("row");
         row.className = "row";

         container.insertBefore(row,document.getElementsByClassName("row_placeholder")[0]);

         for(index = 0; index < data.media.length;index++){
           
           var main_div = document.createElement("div");
           main_div.classList.add("col-lg-3","col-md-4","col-sm-6","portfolio-item");

             var card_div = document.createElement("a");
             card_div.addEventListener("click",function(){
               download_movie(this.id);
             });
             card_div.id = data.media[index].uid;
             card_div.style = "color:white;text-decoration:none";
             card_div.classList.add("card","h-100");
             main_div.appendChild(card_div);

               var card_img = document.createElement("img");
               card_img.className = "card-img-top";
               card_img.src = "/pics/"+data.media[index].uid+".jpeg";
               card_img.alt = "";
               card_div.appendChild(card_img);

               var card_body = document.createElement("div");
               card_body.className = "card-body";
               if(data.media[index].status == "none"){
                 card_body.setAttribute("style","background-color: #353b41;");
               }
               else if(data.media[index].status == "working"){
                 card_body.setAttribute("style","background-color: #353b41;");
                 
                 var progress_bar_container = document.createElement("div");
                 progress_bar_container.className = "progress";
                 progress_bar_container.setAttribute("style","margin-bottom:30px;")
                 card_body.appendChild(progress_bar_container);

                 var progress_bar = document.createElement("div");
                 progress_bar.className = "progress-bar"
                 progress_bar.setAttribute("role","progressbar");
                 progress_bar.setAttribute("aria-valuenow","0");
                 progress_bar.setAttribute("aria-valuemin","0");
                 progress_bar.setAttribute("aria-valuemax","100");
                 progress_bar.setAttribute("style","height:10px;width:0%;background-color:#cc7b19");
                 progress_bar_container.appendChild(progress_bar);

                 var progress_bar_inner = document.createElement("span");
                 progress_bar_inner.className = "sr-only";
                 progress_bar_inner.innerHTML = "0%";
                 progress_bar.appendChild(progress_bar_inner);
               }
               card_div.appendChild(card_body);

                 var card_title = document.createElement("h4");
                 card_title.className = "card-title";
                 card_body.appendChild(card_title);

                   var card_title_link = document.createElement("a");
                   card_title_link.text = data.media[index].title;
                   card_title.appendChild(card_title_link);

                 var card_text = document.createElement("p");
                 card_text.className = "card-text";
                 //card_text.innerHTML = "example";
                 card_body.appendChild(card_text);


           row.appendChild(main_div);
         }
       }

       function build_progress(data){
         for(var i in data.media_progress){
           var card_div = document.getElementById(data.media_progress[i].uid);
           var card_body = card_div.children[1];
           for(child = 0; child < card_body.children.length;child++){
             if(card_body.children[child].className == "progress"){
               card_body.removeChild(card_body.children[child]);
             }
           }

           var progress_bar_container = document.createElement("div");
           progress_bar_container.className = "progress";
           progress_bar_container.setAttribute("style","margin-bottom:30px;")
           card_body.insertBefore(progress_bar_container,card_body.children[0]);

           var progress_bar = document.createElement("div");
           progress_bar.className = "progress-bar"
           progress_bar.setAttribute("role","progressbar");
           progress_bar.setAttribute("aria-valuenow",data.media_progress[i].progress);
           progress_bar.setAttribute("aria-valuemin","0");
           progress_bar.setAttribute("aria-valuemax","100");
           progress_bar.setAttribute("style","height:10px;width:"+data.media_progress[i].progress+"%;background-color:#cc7b19");
           progress_bar_container.appendChild(progress_bar);

           var progress_bar_inner = document.createElement("span");
           progress_bar_inner.className = "sr-only";
           progress_bar_inner.innerHTML = data.media_progress[i].progress+"%";
           progress_bar.appendChild(progress_bar_inner);
               
         }        
       }


       socket.on('media_data', function(data){
         build_data(data);
       });
       socket.on('media_progress',function(data){
         build_progress(data);
       });

  </script>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#">Plex Movie Downloader</a> <button aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#navbarResponsive" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <li class="nav-item"><span class="icon"><i class="fa fa-search"></i></span><input id="search_bar" type="text" value=""></li>
        <li class="nav-item"><button aria-label="Search" id="plex_button"><span aria-hidden="true">Search</span><span class="sr-only">Search</span></button></li>
      </div>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="home">Home</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="movies">Movies <span class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="tv_shows">TV Shows</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="logout">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav><!-- Page Content -->
  <div class="container">
    <!-- Page Heading -->
    <h1 class="my-4">Movies <small>Secondary Text</small></h1><!-- /.row -->
    <div class="row_placeholder"></div><!-- Pagination -->
    <ul class="pagination justify-content-center">
      <li class="page-item"><button aria-label="Previous" class="page-link" onclick="previous_page()"><span aria-hidden="true">Previous</span> <span class="sr-only">Previous</span></button></li>
      <li class="page-item"><button aria-label="Next" class="page-link" onclick="next_page()"><span aria-hidden="true">Next</span> <span class="sr-only">Next</span></button></li>
    </ul>
  </div><!-- /.container -->
  <!-- Footer -->
  <footer class="py-5 bg-dark">
    <div class="container">
      <p class="m-0 text-center text-white">Copyright &copy; Your Website 2017</p>
    </div><!-- /.container -->
  </footer><!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js">
  </script> 
  <script src="vendor/popper/popper.min.js">
  </script> 
  <script src="vendor/bootstrap/js/bootstrap.min.js">
  </script>
</body>
</html>